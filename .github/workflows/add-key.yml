on:
  repository_dispatch:
    types: [add-pgp-key]

jobs:
  extract-and-save:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Extract email and save PGP key
        run: |
          # Decode the key data
          echo "${{ github.event.client_payload.key_data }}" | python3 -c "import sys, urllib.parse; print(urllib.parse.unquote(sys.stdin.read()))" > key.asc

          # Extract email from the key
          EMAIL=$(grep -oP '(?<=<)[^>]+(?=>)' key.asc | head -n1)

          if [ -z "$EMAIL" ]; then
            echo "No email found in key!"
            exit 1
          fi

          # Save the key under the email filename
          mkdir -p pgp_keys
          cp key.asc "pgp_keys/$EMAIL.asc"

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add pgp_keys/
          git commit -m "Add PGP key for $EMAIL"
          git push
